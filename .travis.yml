# Use new trusty images, should yield newer compilers and packages
sudo: required
dist: trusty
language: cpp

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    # Install GCC
    - gcc-5
    - g++-5
    # Install Python
    - python
    - python-dev
    - python-pip
    # Install LibSSL
    - libssl-dev
    # Install Protocol Buffer Compiler
    - protobuf-compiler
    - libprotobuf-dev
services:
  # Start up Docker
  - docker
  - redis
before_install:
  - sudo unlink /usr/bin/gcc && sudo ln -s /usr/bin/gcc-5 /usr/bin/gcc
  - sudo unlink /usr/bin/g++ && sudo ln -s /usr/bin/g++-5 /usr/bin/g++
  # Print the version of gcc
  - gcc --version
  # Print the python & pip version
  - python -V
  - pip -V
  # Install python protocol buffer & zmq modules
  - sudo pip install protobuf pyzmq
  - pip install protobuf pyzmq
  - sudo pip install --user protobuf pyzmq
  # Get DVS Interfaces
  - git clone https://github.com/AO-StreetArt/DvsInterface.git
  - cd DvsInterface && sudo make install
  - sudo docker network create dvs
  # Clone the repository for the python tests
  - cd $TRAVIS_BUILD_DIR
  - git clone https://github.com/AO-StreetArt/0-Meter.git
install:
  - cd $TRAVIS_BUILD_DIR
  # Setup Consul
  - sudo docker pull consul
  - sudo docker run -d --name=registry --network=dvs consul
  # Set up Neo4j
  - sudo docker pull neo4j
  - sudo docker run -d --publish=7474:7474 --publish=7687:7687 --env=NEO4J_AUTH=none --volume=$HOME/neo4j/data:/data --network=dvs --name=database neo4j
  # Set up Redis
  - sudo docker pull redis
  - sudo docker run --network=dvs --name=cache -d redis
  # Populate Consul Configuration variables
  - sudo docker exec -t registry curl -X PUT -d 'localhost--6379----2--5--0' http://localhost:8500/v1/kv/ivan/RedisConnectionString
  - sudo docker exec -t registry curl -X PUT -d 'neo4j://database:7687' http://localhost:8500/v1/kv/ivan/DB_ConnectionString
  - sudo docker exec -t registry curl -X PUT -d 'True' http://localhost:8500/v1/kv/ivan/StampTransactionId
  - sudo docker exec -t registry curl -X PUT -d 'True' http://localhost:8500/v1/kv/ivan/AtomicTransactions
  - sudo docker exec -t registry curl -X PUT -d 'Json' http://localhost:8500/v1/kv/ivan/Data_Format_Type
before_script:
  # Wait for some time to allow the docker instance to finish building
  - cd $TRAVIS_BUILD_DIR/scripts/linux && ./build_docker_instance.sh $TRAVIS_BRANCH $TRAVIS_BUILD_DIR
  # Start Crazy Ivan
  - cd $TRAVIS_BUILD_DIR/scripts/linux && ./run_docker_instance.sh $TRAVIS_BRANCH registry:8500 localhost 5555
  # Show the logs from the crazy ivan docker container
  - sudo docker logs --tail 75 crazyivan
  - sleep 30
script:
  # Execute the Python Tests

  # Success tests
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_crt.xml
  - tail $TRAVIS_BUILD_DIR/scene_crt.log
  - sudo docker logs --tail 75 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_get.xml
  - tail $TRAVIS_BUILD_DIR/scene_get.log
  - sudo docker logs --tail 75 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_update.xml
  - tail $TRAVIS_BUILD_DIR/scene_update.log
  - sudo docker logs --tail 75 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_get.xml
  - tail $TRAVIS_BUILD_DIR/scene_get.log
  - sudo docker logs --tail 75 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/query.xml
  - tail $TRAVIS_BUILD_DIR/scene_query.log
  - sudo docker logs --tail 75 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/dev_register.xml
  - tail $TRAVIS_BUILD_DIR/device_register.log
  - sudo docker logs --tail 100 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/dev_align.xml
  - tail $TRAVIS_BUILD_DIR/device_align.log
  - sudo docker logs --tail 100 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/dev_deregister.xml
  - tail $TRAVIS_BUILD_DIR/device_deregister.log
  - sudo docker logs --tail 100 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_del.xml
  - tail $TRAVIS_BUILD_DIR/scene_del.log
  - sudo docker logs --tail 75 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_get_bad.xml
  - tail $TRAVIS_BUILD_DIR/scene_get.log
  - sudo docker logs --tail 75 crazyivan

  # Failure tests
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_crt_bad.xml
  - tail $TRAVIS_BUILD_DIR/scene_get.log
  - sudo docker logs --tail 50 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_get_bad.xml
  - tail $TRAVIS_BUILD_DIR/scene_get.log
  - sudo docker logs --tail 50 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_upd_bad.xml
  - tail $TRAVIS_BUILD_DIR/scene_upd.log
  - sudo docker logs --tail 50 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/scene_del_bad.xml
  - tail $TRAVIS_BUILD_DIR/scene_del.log
  - sudo docker logs --tail 50 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/query_bad.xml
  - tail $TRAVIS_BUILD_DIR/scene_query.log
  - sudo docker logs --tail 50 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/dev_align_bad.xml
  - tail $TRAVIS_BUILD_DIR/device_align.log
  - sudo docker logs --tail 50 crazyivan
  - cd $TRAVIS_BUILD_DIR && python 0-Meter/0-meter.py ci/dev_deregister_bad.xml
  - tail $TRAVIS_BUILD_DIR/device_deregister.log
  - sudo docker logs --tail 50 crazyivan
after_success:
  # Push the built image to docker hub
  - cd $TRAVIS_BUILD_DIR/scripts/linux && ./push_docker_image.sh $DOCKER_MAIL $DOCKER_UN $DOCKER_PW $TRAVIS_BRANCH $TRAVIS_BUILD_DIR
